name: iOS CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode (ุฅุตูุงุญ: ุงุณุชุฎุฏุงู ุฅุตุฏุงุฑ ูุชุงุญ)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          # ุชู ุงูุชุบููุฑ ูู '15.0' ุฅูู ุฅุตุฏุงุฑ ูุชููุฑ ุนูู Runner
          xcode-version: '16.4'

      - name: Show Xcode version for verification
        run: |
          echo "๐ฑ ุฅุตุฏุงุฑ Xcode ุงููุซุจุช:"
          xcodebuild -version
          echo ""
          echo "๐ง ุฅุตุฏุงุฑ Swift:"
          swift --version

      - name: Install Apple Certificate and Provisioning Profile (ุฅุตูุงุญ: ูุดููุฉ ูู ุงูุชุฑููุฒ)
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # ========== ุงูุชุญูู ูู ุงูุฃุณุฑุงุฑ ==========
          echo "๐ ุฌุงุฑู ุงูุชุญูู ูู ูุฌูุฏ ุงูุฃุณุฑุงุฑ ุงููุทููุจุฉ..."
          
          if [ -z "$BUILD_CERTIFICATE_BASE64" ] || [ "$BUILD_CERTIFICATE_BASE64" = "" ]; then
            echo "โ ุฎุทุฃ: BUILD_CERTIFICATE_BASE64 ูุงุฑุบ ุฃู ุบูุฑ ูุนูู"
            echo "   ูุฑุฌู ุฅุถุงูุฉ ุงูุณุฑ ูู Settings โ Secrets โ Actions"
            exit 1
          fi
          
          if [ -z "$BUILD_PROVISION_PROFILE_BASE64" ] || [ "$BUILD_PROVISION_PROFILE_BASE64" = "" ]; then
            echo "โ ุฎุทุฃ: BUILD_PROVISION_PROFILE_BASE64 ูุงุฑุบ ุฃู ุบูุฑ ูุนูู"
            exit 1
          fi
          
          # ========== ุฅูุดุงุก ุงููุณุงุฑุงุช ==========
          CERTIFICATE_PATH="$RUNNER_TEMP/build_certificate.p12"
          PP_PATH="$RUNNER_TEMP/build_pp.mobileprovision"
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
          
          echo "๐ ูุณุงุฑุงุช ุงููููุงุช:"
          echo "   ุงูุดูุงุฏุฉ: $CERTIFICATE_PATH"
          echo "   ููู ุงูุชุนุฑูู: $PP_PATH"
          echo "   Keychain: $KEYCHAIN_PATH"
          
          # ========== ุฅูุดุงุก Keychain ุฌุฏูุฏ ==========
          echo "๐ ุฌุงุฑู ุฅูุดุงุก Keychain ุฌุฏูุฏ..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # ุชูุนูู Keychain ูุงูุชุฑุงุถู ููุจูุงุก
          security default-keychain -s "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          
          # ========== ูู ุชุฑููุฒ ูุงุณุชูุฑุงุฏ ุงูุดูุงุฏุฉ ==========
          echo "๐ฅ ุฌุงุฑู ูู ุชุฑููุฒ ุงูุดูุงุฏุฉ..."
          
          # ุทุฑููุฉ ูุญุณูุฉ ููู ุงูุชุฑููุฒ ูุน ูุนุงูุฌุฉ ุงูุฃุญุฑู ุงูุฌุฏูุฏุฉ
          CLEAN_CERT=$(echo "$BUILD_CERTIFICATE_BASE64" | tr -d '\n\r' | sed 's/ //g')
          echo "$CLEAN_CERT" | base64 --decode --output "$CERTIFICATE_PATH" 2>/dev/null || {
            echo "โ๏ธ  ูุดูุช ุงููุญุงููุฉ ุงูุฃูููุ ุฌุฑุจ ุทุฑููุฉ ุจุฏููุฉ..."
            echo "$BUILD_CERTIFICATE_BASE64" | base64 --decode --ignore-garbage --output "$CERTIFICATE_PATH" 2>/dev/null || {
              echo "โ ูุดู ูู ุชุฑููุฒ ุงูุดูุงุฏุฉ ุชูุงููุง"
              echo "   ุชุญูู ูู ุตูุบุฉ Base64 ููุณุฑ BUILD_CERTIFICATE_BASE64"
              echo "   ุงูุทูู: ${#BUILD_CERTIFICATE_BASE64} ุญุฑู"
              echo "   ุฃูู 50 ุญุฑู: ${BUILD_CERTIFICATE_BASE64:0:50}"
              exit 1
            }
          }
          
          # ุงูุชุญูู ูู ุญุฌู ุงูููู ุงูููููู
          CERT_SIZE=$(wc -c < "$CERTIFICATE_PATH")
          echo "   โ ุชู ูู ุชุฑููุฒ ุงูุดูุงุฏุฉุ ุงูุญุฌู: $CERT_SIZE ุจุงูุช"
          
          if [ $CERT_SIZE -lt 100 ]; then
            echo "โ ููู ุงูุดูุงุฏุฉ ุตุบูุฑ ุฌุฏูุง (ูุฏ ูููู ุชุฑููุฒ Base64 ุฎุงุทุฆ)"
            exit 1
          fi
          
          # ุงูุชุญูู ูู ููุน ุงูููู
          echo "   ููุน ุงูููู:"
          file "$CERTIFICATE_PATH"
          
          # ========== ุงุณุชูุฑุงุฏ ุงูุดูุงุฏุฉ ุฅูู Keychain ==========
          echo "๐ ุฌุงุฑู ุงุณุชูุฑุงุฏ ุงูุดูุงุฏุฉ ุฅูู Keychain..."
          
          if [ -z "$P12_PASSWORD" ] || [ "$P12_PASSWORD" = "" ]; then
            echo "   โ๏ธ  P12_PASSWORD ูุงุฑุบุ ุฌุฑุจ ุงูุงุณุชูุฑุงุฏ ุจุฏูู ูููุฉ ูุฑูุฑ"
            IMPORT_CMD="security import \"$CERTIFICATE_PATH\" -A -t cert -f pkcs12 -k \"$KEYCHAIN_PATH\" -T /usr/bin/codesign"
          else
            echo "   ๐ ุงุณุชุฎุฏุงู ูููุฉ ุงููุฑูุฑ ุงููุฒูุฏุฉ"
            IMPORT_CMD="security import \"$CERTIFICATE_PATH\" -P \"$P12_PASSWORD\" -A -t cert -f pkcs12 -k \"$KEYCHAIN_PATH\" -T /usr/bin/codesign"
          fi
          
          eval $IMPORT_CMD 2>&1 | while read line; do
            echo "   $line"
          done
          
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "โ ูุดู ุงุณุชูุฑุงุฏ ุงูุดูุงุฏุฉ"
            echo "   ุฌุฑุจ ูุน ุฎูุงุฑุงุช ูุฎุชููุฉ..."
            
            # ุชุฌุฑุจุฉ ุจุฏูู -T /usr/bin/codesign
            security import "$CERTIFICATE_PATH" -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH" 2>&1 || {
              echo "โ ูุดู ุงุณุชูุฑุงุฏ ุงูุดูุงุฏุฉ ุชูุงููุง"
              exit 1
            }
          fi
          
          # ุฅุนุฏุงุฏ ุฃุฐููุงุช Keychain
          echo "   ๐ง ุฅุนุฏุงุฏ ุฃุฐููุงุช Keychain..."
          security set-key-partition-list -S "apple-tool:,apple:,codesign:" -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # ========== ูู ุชุฑููุฒ ูุงุณุชูุฑุงุฏ ููู ุงูุชุนุฑูู ==========
          echo "๐ ุฌุงุฑู ูู ุชุฑููุฒ ููู ุงูุชุนุฑูู (Provisioning Profile)..."
          
          # ุชูุธูู ุจูุงูุงุช Base64 ูููู ุงูุชุนุฑูู
          CLEAN_PP=$(echo "$BUILD_PROVISION_PROFILE_BASE64" | tr -d '\n\r' | sed 's/ //g')
          echo "$CLEAN_PP" | base64 --decode --output "$PP_PATH" 2>/dev/null || {
            echo "โ ูุดู ูู ุชุฑููุฒ ููู ุงูุชุนุฑูู"
            exit 1
          }
          
          # ุงุณุชุฎุฑุงุฌ UUID ูู ููู ุงูุชุนุฑูู
          PP_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< $(security cms -D -i "$PP_PATH" 2>/dev/null) 2>/dev/null || echo "unknown_uuid")
          
          if [ -z "$PP_UUID" ] || [ "$PP_UUID" = "" ]; then
            PP_UUID="profile_$RANDOM"
          fi
          
          echo "   โ ุชู ูู ุชุฑููุฒ ููู ุงูุชุนุฑููุ UUID: $PP_UUID"
          
          # ูุณุฎ ููู ุงูุชุนุฑูู ุฅูู ุงูููุงู ุงูุตุญูุญ
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/"$PP_UUID".mobileprovision
          
          # ========== ุงูุชุญูู ุงูููุงุฆู ==========
          echo "โ ุงูุชุญูู ูู ุงูุชุซุจูุช..."
          
          echo "   ๐ ุงูุดูุงุฏุงุช ูู Keychain:"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH" 2>&1 | head -10 || echo "   โ๏ธ  ูุง ุชูุฌุฏ ุดูุงุฏุงุช ุฃู ุญุฏุซ ุฎุทุฃ"
          
          echo "   ๐ ูููุงุช ุงูุชุนุฑูู ุงููุซุจุชุฉ:"
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/ 2>&1 | head -5 || echo "   โ๏ธ  ูุง ุชูุฌุฏ ูููุงุช ุชุนุฑูู"
          
          echo "๐ ุชู ุชุซุจูุช ุงูุดูุงุฏุฉ ูููู ุงูุชุนุฑูู ุจูุฌุงุญ!"

      - name: Build the iOS App (ุจุฏูู ุชูููุน ููุงุฎุชุจุงุฑ)
        id: build_app
        run: |
          echo "๐๏ธ  ุฌุงุฑู ุจูุงุก ุงูุชุทุจูู..."
          
          # ุจูุงุก ุจุฏูู ุชูููุน ุฃููุงู ููุงุฎุชุจุงุฑ
          xcodebuild clean build \
            -project SimpleTableApp.xcodeproj \
            -scheme SimpleTableApp \
            -configuration Debug \
            -destination 'generic/platform=iOS Simulator' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO 2>&1 | tee build.log
          
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "โ ุชู ุงูุจูุงุก ุจูุฌุงุญ (ุจุฏูู ุชูููุน)"
            echo "build_status=success" >> $GITHUB_OUTPUT
          else
            echo "โ ูุดู ุงูุจูุงุก"
            echo "build_status=failed" >> $GITHUB_OUTPUT
            echo "=== ุขุฎุฑ 20 ุณุทุฑ ูู ุณุฌู ุงูุจูุงุก ==="
            tail -20 build.log
            exit 1
          fi

      - name: Build with Signing (If secrets exist)
        if: env.BUILD_CERTIFICATE_BASE64 != '' && env.BUILD_PROVISION_PROFILE_BASE64 != '' && steps.build_app.outputs.build_status == 'success'
        run: |
          echo "๐ ุฌุงุฑู ุงูุจูุงุก ูุน ุงูุชูููุน..."
          
          # ุงูุจุญุซ ุนู ูุนุฑู ุงูุดูุงุฏุฉ
          CERT_IDENTITY=$(security find-identity -v -p codesigning "$RUNNER_TEMP/app-signing.keychain-db" | grep ")" | head -1 | cut -d '"' -f 2)
          
          if [ -z "$CERT_IDENTITY" ]; then
            echo "โ๏ธ  ูู ูุชู ุงูุนุซูุฑ ุนูู ุดูุงุฏุฉ ุชูููุนุ ุงูุจูุงุก ุจุฏูู ุชูููุน"
            CERT_IDENTITY=""
            PROVISIONING_PROFILE_SPECIFIER=""
          else
            echo "   โ ุงุณุชุฎุฏุงู ุดูุงุฏุฉ ุงูุชูููุน: $CERT_IDENTITY"
            PROVISIONING_PROFILE_SPECIFIER="PROVISIONING_PROFILE_SPECIFIER"
          fi
          
          # ุงูุจูุงุก ูุน ุงูุชูููุน (ุฅู ูุฌุฏ)
          xcodebuild clean build \
            -project SimpleTableApp.xcodeproj \
            -scheme SimpleTableApp \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_IDENTITY="$CERT_IDENTITY" \
            OTHER_CODE_SIGN_FLAGS="--keychain $RUNNER_TEMP/app-signing.keychain-db" \
            $PROVISIONING_PROFILE_SPECIFIER 2>&1 | tee build_signed.log
          
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "โ ุชู ุงูุจูุงุก ูุน ุงูุชูููุน ุจูุฌุงุญ"
          else
            echo "โ ูุดู ุงูุจูุงุก ูุน ุงูุชูููุน"
            echo "=== ุขุฎุฑ 20 ุณุทุฑ ูู ุณุฌู ุงูุจูุงุก ==="
            tail -20 build_signed.log
            # ูุง ูููู ุงูุนูููุฉ ููุงุ ูุชุงุจุน ุจุฏูู ุชูููุน
          fi

      - name: Archive the iOS App (ููุฅุตุฏุงุฑ)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "๐ฆ ุฌุงุฑู ุฃุฑุดูุฉ ุงูุชุทุจูู ููุฅุตุฏุงุฑ..."
          
          # ุงูุจุญุซ ุนู ูุนุฑู ุงูุดูุงุฏุฉ
          CERT_IDENTITY=$(security find-identity -v -p codesigning "$RUNNER_TEMP/app-signing.keychain-db" | grep ")" | head -1 | cut -d '"' -f 2)
          
          if [ -z "$CERT_IDENTITY" ]; then
            echo "โ๏ธ  ูุง ูููู ุงูุฃุฑุดูุฉ ุจุฏูู ุดูุงุฏุฉ ุชูููุน ุตุงูุญุฉ"
            echo "archive_status=no_certificate" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "   ๐ ุงูุฃุฑุดูุฉ ุจุงุณุชุฎุฏุงู ุงูุดูุงุฏุฉ: $CERT_IDENTITY"
          
          xcodebuild archive \
            -project SimpleTableApp.xcodeproj \
            -scheme SimpleTableApp \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath ./build/SimpleTableApp.xcarchive \
            CODE_SIGN_IDENTITY="$CERT_IDENTITY" \
            OTHER_CODE_SIGN_FLAGS="--keychain $RUNNER_TEMP/app-signing.keychain-db" \
            PROVISIONING_PROFILE_SPECIFIER 2>&1 | tee archive.log
          
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "โ ุชู ุงูุฃุฑุดูุฉ ุจูุฌุงุญ"
            echo "archive_status=success" >> $GITHUB_ENV
            
            # ุงูุชุญูู ูู ูุฌูุฏ ุงูุฃุฑุดูู
            if [ -d "./build/SimpleTableApp.xcarchive" ]; then
              echo "๐ ุญุฌู ุงูุฃุฑุดูู:"
              du -sh ./build/SimpleTableApp.xcarchive
            fi
          else
            echo "โ ูุดู ุงูุฃุฑุดูุฉ"
            echo "archive_status=failed" >> $GITHUB_ENV
            echo "=== ุขุฎุฑ 20 ุณุทุฑ ูู ุณุฌู ุงูุฃุฑุดูุฉ ==="
            tail -20 archive.log
          fi

      - name: Sanitize Archive Name (ููุชูุงูู ูุน upload-artifact@v4)
        if: env.archive_status == 'success'
        id: sanitize_name
        run: |
          # ุฅุตูุงุญ: ุฅุฒุงูุฉ ุงูุฃุญุฑู ุบูุฑ ุงููุชูุงููุฉ ูุน ุฃุณูุงุก ุงููููุงุช
          SANITIZED_NAME="SimpleTableApp_Archive_${{ github.run_number }}_${{ github.sha }}"
          SANITIZED_NAME="${SANITIZED_NAME//|/_}"
          SANITIZED_NAME="${SANITIZED_NAME//\*/_}"
          SANITIZED_NAME="${SANITIZED_NAME//\//_}"
          SANITIZED_NAME="${SANITIZED_NAME//\\/_}"
          SANITIZED_NAME="${SANITIZED_NAME//:/_}"
          SANITIZED_NAME="${SANITIZED_NAME//\"/_}"
          SANITIZED_NAME="${SANITIZED_NAME//</_}"
          SANITIZED_NAME="${SANITIZED_NAME//>/_}"
          SANITIZED_NAME="${SANITIZED_NAME//?/_}"
          SANITIZED_NAME="${SANITIZED_NAME// /_}"
          
          echo "๐งน ุงูุงุณู ุงูููุณู ููุฃุฑุดูู: $SANITIZED_NAME"
          echo "sanitized_name=$SANITIZED_NAME" >> $GITHUB_OUTPUT

      - name: Upload App Archive (ุฅุตูุงุญ: ุงุณุชุฎุฏุงู v4 ุจุฏูุงู ูู v3)
        if: env.archive_status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.sanitize_name.outputs.sanitized_name }}
          path: ./build/SimpleTableApp.xcarchive
          retention-days: 7
          compression-level: 0

      - name: Run Unit Tests
        run: |
          echo "๐งช ุฌุงุฑู ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช..."
          xcodebuild test \
            -project SimpleTableApp.xcodeproj \
            -scheme SimpleTableApp \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -enableCodeCoverage YES 2>&1 | tee test.log
          
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "โ ุชู ุชูููุฐ ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุจูุฌุงุญ"
          else
            echo "โ ูุดู ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช"
            echo "=== ููุฎุต ุณุฌู ุงูุงุฎุชุจุงุฑุงุช ==="
            grep -A5 -B5 "FAILED\|error:" test.log || tail -30 test.log
            # ูุง ูููู ุงูุนูููุฉ ููุงุ ูุชุฑู ุงูุงุฎุชุจุงุฑ ููุดู ุจุดูู ุทุจูุนู
          fi

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Download App Archive (ุฅุตูุงุญ: ุงุณุชุฎุฏุงู v4)
        uses: actions/download-artifact@v4
        with:
          pattern: SimpleTableApp_Archive_*
          path: ./downloaded-artifacts

      - name: List Downloaded Files
        run: |
          echo "๐ ุงููููุงุช ุงูุชู ุชู ุชูุฒูููุง:"
          find ./downloaded-artifacts -type f -name "*.xcarchive" | head -5
          echo ""
          echo "๐ ุญุฌู ุงููููุงุช:"
          du -sh ./downloaded-artifacts/* 2>/dev/null || echo "ูุง ุชูุฌุฏ ุฃุฑุดููุงุช"

      - name: Create Release Summary
        run: |
          echo "## ๐ ุจูุงุก ุชุทุจูู iOS ุจูุฌุงุญ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ๐ ูุนูููุงุช ุงูุจูุงุก" >> $GITHUB_STEP_SUMMARY
          echo "- **ุงูุชุทุจูู:** SimpleTableApp" >> $GITHUB_STEP_SUMMARY
          echo "- **ุฑูู ุงูุจูุงุก:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ุงููุฑุฌุน:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ุงููุฑุน:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ูุธุงู ุงูุชุดุบูู:** macOS (GitHub Runner)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ๐ฆ ุงููุฎุฑุฌุงุช" >> $GITHUB_STEP_SUMMARY
          echo "ุชู ุฅูุดุงุก ุฃุฑุดูู ุงูุชุทุจูู ูุฌุงูุฒ ููุชุญููู." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ" >> $GITHUB_STEP_SUMMARY
          echo "1. ููููู ุชูุฒูู ุงูุฃุฑุดูู ูู ุชุจููุจ **Artifacts**" >> $GITHUB_STEP_SUMMARY
          echo "2. ุงุณุชุฎุฏู Xcode ูุชุตุฏูุฑ IPA ูู ุงูุฃุฑุดูู" >> $GITHUB_STEP_SUMMARY
          echo "3. ูุดูุฑ ุงูุชุทุจูู ุนูู TestFlight ุฃู App Store" >> $GITHUB_STEP_SUMMARY
